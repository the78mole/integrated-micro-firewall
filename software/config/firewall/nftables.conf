# nftables configuration for the Integrated Micro Firewall
# Use Case: HP iLO Protection
#
# Deploy to: /etc/nftables.conf on the IMF
# Enable:    systemctl enable --now nftables

flush ruleset

define ETH_EXT   = eth1     # External / uplink interface
define ETH_MGMT  = eth0     # Management / iLO-side interface
define WG_IF     = wg0      # WireGuard tunnel interface
define WG_PORT   = 51820    # WireGuard UDP listen port
define ILO_HTTPS = 443      # HP iLO web UI
define ILO_SSH   = 22       # HP iLO SSH

table inet filter {

    chain input {
        type filter hook input priority filter; policy drop;

        # Allow established / related connections
        ct state { established, related } accept

        # Loopback interface
        iifname lo accept

        # ICMPv4 echo-request – rate-limited
        ip protocol icmp icmp type echo-request limit rate 5/second accept

        # ICMPv6 echo-request – rate-limited
        ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 5/second accept

        # WireGuard: accept incoming handshake on the external interface
        iifname $ETH_EXT udp dport $WG_PORT accept

        # SSH to IMF itself – only from the WireGuard tunnel
        iifname $WG_IF tcp dport 22 accept

        # Drop everything else and log
        log prefix "IMF-INPUT-DROP: " drop
    }

    chain forward {
        type filter hook forward priority filter; policy drop;

        # Allow established / related connections
        ct state { established, related } accept

        # WireGuard peer → iLO management interface
        iifname $WG_IF oifname $ETH_MGMT tcp dport { $ILO_HTTPS, $ILO_SSH } accept

        # Drop everything else and log
        log prefix "IMF-FORWARD-DROP: " drop
    }

    chain output {
        type filter hook output priority filter; policy accept;
    }
}
